<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outlook AI 2.0 - çœŸå¯¦ç‰ˆï¼ˆæ•´åˆ OpenAI APIï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* é ‚éƒ¨å·¥å…·åˆ— */
        .toolbar {
            background: white;
            border-radius: 16px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .toolbar h1 {
            font-size: 28px;
            color: #2d3748;
            flex: 1;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-indicator.connected {
            background: #c6f6d5;
            color: #2f855a;
        }

        .status-indicator.loading {
            background: #feebc8;
            color: #c05621;
        }

        .status-indicator.error {
            background: #fed7d7;
            color: #c53030;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        /* ä¸»è¦å…§å®¹å€ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        /* å·¦å´ï¼šå¯„ä»¶äººç®¡ç†å€ */
        .senders-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 24px;
            color: #2d3748;
        }

        /* ä¸‰ç‹€æ…‹å€åŸŸ */
        .status-zone {
            padding: 20px;
            border-radius: 12px;
            border: 2px dashed #e2e8f0;
            min-height: 150px;
            margin-bottom: 24px;
            transition: all 0.3s;
        }

        .status-zone.drag-over {
            border-color: #667eea;
            background: #f7fafc;
            transform: scale(1.02);
        }

        .status-zone.pending {
            background: #fff5f5;
            border-color: #feb2b2;
        }

        .status-zone.processing {
            background: #fffaf0;
            border-color: #fbd38d;
        }

        .status-zone.completed {
            background: #f0fff4;
            border-color: #9ae6b4;
        }

        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .zone-header h3 {
            font-size: 18px;
            color: #2d3748;
        }

        .zone-count {
            background: rgba(0,0,0,0.1);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
        }

        /* å¯„ä»¶äººå¡ç‰‡ç¶²æ ¼ */
        .senders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .sender-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            cursor: move;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .sender-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .sender-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .sender-card.selected {
            border: 3px solid #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            position: relative;
        }

        .unread-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #fc8181;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .sender-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .sender-email {
            font-size: 11px;
            color: #718096;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tag {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 8px;
            font-weight: 600;
        }

        .tag-urgent { background: #fed7d7; color: #c53030; }
        .tag-high { background: #feebc8; color: #c05621; }
        .tag-medium { background: #c6f6d5; color: #2f855a; }
        .tag-value { background: #bee3f8; color: #2c5282; }
        .tag-ai { background: #e9d8fd; color: #6b46c1; }

        /* éƒµä»¶åˆ—è¡¨ */
        .emails-list-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid #e2e8f0;
        }

        .emails-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .emails-list-header h3 {
            font-size: 18px;
            color: #2d3748;
        }

        .close-list-btn {
            background: #e2e8f0;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #4a5568;
        }

        .close-list-btn:hover {
            background: #cbd5e0;
        }

        .email-item {
            background: #f7fafc;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .email-item:hover {
            background: #edf2f7;
            border-left-color: #667eea;
            transform: translateX(4px);
        }

        .email-item.selected {
            background: #e6fffa;
            border-left-color: #38b2ac;
        }

        .email-item.unread {
            background: #ebf8ff;
            font-weight: 600;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .email-subject {
            font-size: 14px;
            color: #2d3748;
            font-weight: 600;
            flex: 1;
        }

        .email-time {
            font-size: 12px;
            color: #718096;
            margin-left: 12px;
        }

        .email-preview {
            font-size: 12px;
            color: #718096;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* å³å´ï¼šAI åˆ†æé¢æ¿ */
        .ai-panel {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .ai-panel h2 {
            font-size: 24px;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .ai-section {
            background: #f7fafc;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .ai-section h3 {
            font-size: 16px;
            color: #4a5568;
            margin-bottom: 12px;
        }

        .note-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.6;
        }

        .note-item strong {
            color: #667eea;
        }

        .ai-cost {
            background: #fef5e7;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #c05621;
            margin-top: 8px;
        }

        /* éƒµä»¶å…§å®¹é¡¯ç¤º */
        .email-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            line-height: 1.8;
            font-size: 14px;
            color: #2d3748;
        }

        .email-content-header {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 16px;
            margin-bottom: 16px;
        }

        .email-content-subject {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 12px;
        }

        .email-content-meta {
            font-size: 13px;
            color: #718096;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #f7fafc;
            border-color: #667eea;
        }

        .action-btn.primary {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        /* Loading å‹•ç•« */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ’°å¯«éƒµä»¶å½ˆçª— */
        .compose-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .compose-modal.active {
            display: flex;
        }

        .compose-dialog {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .compose-header {
            padding: 24px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compose-header h2 {
            font-size: 20px;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #718096;
            cursor: pointer;
        }

        .compose-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 200px;
        }

        .compose-footer {
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .ai-suggestion {
            background: #e9d8fd;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #6b46c1;
        }

        .ai-suggestion-header {
            font-size: 13px;
            font-weight: 600;
            color: #6b46c1;
            margin-bottom: 8px;
        }

        .ai-suggestion-text {
            font-size: 13px;
            color: #4a5568;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¥å…·åˆ— -->
        <div class="toolbar">
            <h1>ğŸ“§ Outlook AI 2.0 - çœŸå¯¦ç‰ˆ</h1>
            <div id="statusIndicator" class="status-indicator loading">
                <div class="loading"></div>
                <span>è¼‰å…¥ä¸­...</span>
            </div>
            <button class="btn btn-primary" onclick="composeEmail()">âœ‰ï¸ æ’°å¯«éƒµä»¶</button>
            <button class="btn btn-secondary" onclick="syncEmails()" id="syncBtn">ğŸ”„ åŒæ­¥éƒµä»¶</button>
        </div>

        <!-- ä¸»è¦å…§å®¹ -->
        <div class="main-content">
            <!-- å·¦å´ï¼šå¯„ä»¶äººç®¡ç† + éƒµä»¶åˆ—è¡¨ -->
            <div class="senders-section">
                <div class="section-header">
                    <h2>ğŸ‘¥ å¯„ä»¶äººç®¡ç†ï¼ˆæ‹–æ‹½ç®¡ç†ç‹€æ…‹ï¼‰</h2>
                </div>

                <!-- å¾…è™•ç† -->
                <div class="status-zone pending" ondrop="drop(event, 'pending')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                    <div class="zone-header">
                        <h3>ğŸ“¬ å¾…è™•ç†</h3>
                        <span class="zone-count" id="pendingCount">0</span>
                    </div>
                    <div class="senders-grid" id="pendingSenders"></div>
                </div>

                <!-- è™•ç†ä¸­ -->
                <div class="status-zone processing" ondrop="drop(event, 'processing')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                    <div class="zone-header">
                        <h3>âš¡ è™•ç†ä¸­</h3>
                        <span class="zone-count" id="processingCount">0</span>
                    </div>
                    <div class="senders-grid" id="processingSenders"></div>
                </div>

                <!-- å·²å®Œæˆ -->
                <div class="status-zone completed" ondrop="drop(event, 'completed')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                    <div class="zone-header">
                        <h3>âœ… å·²å®Œæˆ</h3>
                        <span class="zone-count" id="completedCount">0</span>
                    </div>
                    <div class="senders-grid" id="completedSenders"></div>
                </div>

                <!-- éƒµä»¶åˆ—è¡¨ï¼ˆé»æ“Šå¯„ä»¶äººå¾Œé¡¯ç¤ºï¼‰ -->
                <div class="emails-list-section" id="emailsListSection" style="display: none;">
                    <div class="emails-list-header">
                        <h3 id="emailsListTitle">ğŸ“§ éƒµä»¶åˆ—è¡¨</h3>
                        <button class="close-list-btn" onclick="closeEmailsList()">âœ• é—œé–‰</button>
                    </div>
                    <div id="emailsList"></div>
                </div>
            </div>

            <!-- å³å´ï¼šAI åŠ©ç† -->
            <div class="ai-panel">
                <h2>ğŸ¤– AI æ™ºèƒ½åˆ†æ</h2>
                <div id="aiDetailContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’¡</div>
                        <div>é»æ“Šå¯„ä»¶äººå¡ç‰‡æˆ–éƒµä»¶æŸ¥çœ‹ AI åˆ†æ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ’°å¯«éƒµä»¶å½ˆçª— -->
    <div class="compose-modal" id="composeModal">
        <div class="compose-dialog">
            <div class="compose-header">
                <h2>âœ‰ï¸ æ’°å¯«æ–°éƒµä»¶</h2>
                <button class="close-btn" onclick="closeCompose()">&times;</button>
            </div>
            <div class="compose-body">
                <div id="aiSuggestionContainer"></div>
                <div class="form-group">
                    <label>æ”¶ä»¶äºº</label>
                    <input type="email" id="emailTo" placeholder="example@email.com">
                </div>
                <div class="form-group">
                    <label>ä¸»æ—¨</label>
                    <input type="text" id="emailSubject" placeholder="éƒµä»¶ä¸»æ—¨">
                </div>
                <div class="form-group">
                    <label>å…§å®¹</label>
                    <textarea id="emailBody" placeholder="è¼¸å…¥éƒµä»¶å…§å®¹..."></textarea>
                </div>
            </div>
            <div class="compose-footer">
                <button class="btn btn-secondary" onclick="closeCompose()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="sendEmail()" id="sendBtn">ç™¼é€</button>
            </div>
        </div>
    </div>

    <script>
        // ===== é…ç½® =====
        const API_BASE = 'http://localhost:3000/api';

        // ===== å…¨åŸŸè®Šæ•¸ =====
        let allEmails = [];
        let sendersMap = new Map();
        let selectedSender = null;
        let selectedEmail = null;
        let aiEnabled = false;

        // ===== åˆå§‹åŒ– =====
        async function init() {
            console.log('ğŸš€ Outlook AI 2.0 çœŸå¯¦ç‰ˆå•Ÿå‹•...');

            // æª¢æŸ¥ AI æœå‹™ç‹€æ…‹
            await checkAIStatus();

            // è¼‰å…¥éƒµä»¶
            await loadEmails();
        }

        // ===== æª¢æŸ¥ AI ç‹€æ…‹ =====
        async function checkAIStatus() {
            try {
                const response = await fetch(`${API_BASE}/ai/status`);
                const data = await response.json();

                if (data.success) {
                    aiEnabled = data.status.aiEnhancement;
                    console.log('ğŸ¤– AI ç‹€æ…‹:', aiEnabled ? 'å·²å•Ÿç”¨' : 'åŸºç¤æ¨¡å¼');
                }
            } catch (error) {
                console.error('âŒ ç„¡æ³•æª¢æŸ¥ AI ç‹€æ…‹:', error);
            }
        }

        // ===== è¼‰å…¥éƒµä»¶ =====
        async function loadEmails() {
            updateStatus('loading', 'è¼‰å…¥éƒµä»¶ä¸­...');
            document.getElementById('syncBtn').disabled = true;

            try {
                // ç²å–éƒµä»¶ï¼ˆåŒ…å« AI åˆ†æï¼‰
                const response = await fetch(`${API_BASE}/email/list?limit=100&includeAI=true`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'è¼‰å…¥éƒµä»¶å¤±æ•—');
                }

                allEmails = data.emails || [];
                console.log(`âœ… æˆåŠŸè¼‰å…¥ ${allEmails.length} å°éƒµä»¶`);

                // è™•ç†éƒµä»¶ï¼ŒæŒ‰å¯„ä»¶äººåˆ†çµ„
                processSenders();
                renderSenders();
                updateCounts();

                updateStatus('connected', `å·²è¼‰å…¥ ${allEmails.length} å°éƒµä»¶`);
            } catch (error) {
                console.error('âŒ è¼‰å…¥éƒµä»¶å¤±æ•—:', error);
                updateStatus('error', 'è¼‰å…¥å¤±æ•—: ' + error.message);
            } finally {
                document.getElementById('syncBtn').disabled = false;
            }
        }

        // ===== è™•ç†å¯„ä»¶äººåˆ†çµ„ =====
        function processSenders() {
            sendersMap.clear();

            allEmails.forEach(email => {
                const fromEmail = email.from?.address || email.from?.name || 'unknown@example.com';
                const fromName = email.from?.name || fromEmail.split('@')[0];

                if (!sendersMap.has(fromEmail)) {
                    sendersMap.set(fromEmail, {
                        email: fromEmail,
                        name: fromName,
                        avatar: fromName.charAt(0).toUpperCase(),
                        color: generateColor(fromEmail),
                        status: 'pending', // æ–°éƒµä»¶é è¨­å¾…è™•ç†
                        emails: [],
                        totalEmails: 0,
                        unreadEmails: 0,
                        priority: 'medium',
                        value: null
                    });
                }

                const sender = sendersMap.get(fromEmail);
                sender.emails.push(email);
                sender.totalEmails++;

                // è¨ˆç®—æœªè®€æ•¸é‡
                if (email.flags && !email.flags.includes('\\Seen')) {
                    sender.unreadEmails++;
                }

                // å¾ AI åˆ†æä¸­æå–å„ªå…ˆç´šå’Œåƒ¹å€¼
                if (email.aiAnalysis) {
                    if (email.aiAnalysis.priority === 'high' || email.aiAnalysis.urgency === 'urgent') {
                        sender.priority = 'high';
                    }
                    if (email.aiAnalysis.opportunityValue) {
                        sender.value = email.aiAnalysis.opportunityValue;
                    }
                }
            });

            console.log(`ğŸ‘¥ åˆ†çµ„å®Œæˆ: ${sendersMap.size} ä½å¯„ä»¶äºº`);
        }

        // ===== ç”Ÿæˆé¡è‰² =====
        function generateColor(str) {
            const colors = [
                '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a',
                '#667eea', '#38b2ac', '#ed8936', '#9f7aea', '#48bb78'
            ];
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        // ===== æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨ =====
        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = `status-indicator ${status}`;

            let icon = '';
            if (status === 'loading') icon = '<div class="loading"></div>';
            else if (status === 'connected') icon = 'âœ…';
            else if (status === 'error') icon = 'âŒ';

            indicator.innerHTML = `${icon}<span>${text}</span>`;
        }

        // ===== æ¸²æŸ“å¯„ä»¶äººå¡ç‰‡ =====
        function renderSenders() {
            const pendingDiv = document.getElementById('pendingSenders');
            const processingDiv = document.getElementById('processingSenders');
            const completedDiv = document.getElementById('completedSenders');

            pendingDiv.innerHTML = '';
            processingDiv.innerHTML = '';
            completedDiv.innerHTML = '';

            sendersMap.forEach((sender, email) => {
                const card = createSenderCard(sender);

                if (sender.status === 'pending') {
                    pendingDiv.appendChild(card);
                } else if (sender.status === 'processing') {
                    processingDiv.appendChild(card);
                } else if (sender.status === 'completed') {
                    completedDiv.appendChild(card);
                }
            });

            updateCounts();
        }

        function createSenderCard(sender) {
            const card = document.createElement('div');
            card.className = 'sender-card';
            if (selectedSender && selectedSender.email === sender.email) {
                card.classList.add('selected');
            }
            card.draggable = true;
            card.dataset.senderEmail = sender.email;
            card.ondragstart = drag;
            card.onclick = (e) => {
                e.stopPropagation();
                selectSender(sender);
            };

            const hasAI = sender.emails.some(e => e.aiAnalysis && e.aiAnalysis.aiEnhanced);
            const priorityClass = sender.priority === 'urgent' ? 'tag-urgent' :
                                sender.priority === 'high' ? 'tag-high' : 'tag-medium';
            const priorityIcon = sender.priority === 'urgent' ? 'ğŸ”´' :
                               sender.priority === 'high' ? 'ğŸŸ¡' : 'ğŸŸ¢';

            card.innerHTML = `
                <div class="avatar" style="background: ${sender.color}">
                    ${sender.avatar}
                    ${sender.unreadEmails > 0 ? `<div class="unread-badge">${sender.unreadEmails}</div>` : ''}
                </div>
                <div class="sender-name">${sender.name}</div>
                <div class="sender-email">${sender.email}</div>
                <div style="font-size: 12px; color: #718096; margin-bottom: 8px;">
                    ${sender.totalEmails} å°éƒµä»¶
                </div>
                <div class="tags">
                    <span class="tag ${priorityClass}">${priorityIcon}</span>
                    ${sender.value ? `<span class="tag tag-value">${sender.value}</span>` : ''}
                    ${hasAI ? '<span class="tag tag-ai">ğŸ¤– AI</span>' : ''}
                </div>
            `;

            return card;
        }

        // ===== é¸æ“‡å¯„ä»¶äºº =====
        function selectSender(sender) {
            selectedSender = sender;
            selectedEmail = null;
            renderSenders();
            showEmailsList(sender);
            showSenderAI(sender);
        }

        // ===== é¡¯ç¤ºéƒµä»¶åˆ—è¡¨ =====
        function showEmailsList(sender) {
            const section = document.getElementById('emailsListSection');
            const title = document.getElementById('emailsListTitle');
            const list = document.getElementById('emailsList');

            title.textContent = `ğŸ“§ ${sender.name} çš„éƒµä»¶åˆ—è¡¨ (${sender.totalEmails} å°)`;
            section.style.display = 'block';

            list.innerHTML = '';
            sender.emails.forEach(email => {
                const item = document.createElement('div');
                const isUnread = email.flags && !email.flags.includes('\\Seen');
                item.className = 'email-item' + (isUnread ? ' unread' : '');
                if (selectedEmail && selectedEmail.id === email.id) {
                    item.classList.add('selected');
                }

                const timeStr = formatTime(email.date);

                item.innerHTML = `
                    <div class="email-header">
                        <div class="email-subject">${email.subject || '(ç„¡ä¸»æ—¨)'}</div>
                        <div class="email-time">${timeStr}</div>
                    </div>
                    <div class="email-preview">${(email.text || email.bodyPreview || '').substring(0, 100)}...</div>
                `;

                item.onclick = () => selectEmail(sender, email);
                list.appendChild(item);
            });

            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ===== é¸æ“‡éƒµä»¶ =====
        async function selectEmail(sender, email) {
            selectedEmail = email;
            showEmailsList(sender);
            await showEmailContent(sender, email);
            renderSenders();
        }

        // ===== é¡¯ç¤ºéƒµä»¶å…§å®¹ =====
        async function showEmailContent(sender, email) {
            const contentDiv = document.getElementById('aiDetailContent');

            // é¡¯ç¤ºéƒµä»¶å…§å®¹
            let emailBody = email.html || email.text || email.bodyPreview || '(ç„¡å…§å®¹)';
            if (!email.html && email.text) {
                emailBody = emailBody.replace(/\n/g, '<br>');
            }

            contentDiv.innerHTML = `
                <div class="email-content">
                    <div class="email-content-header">
                        <div class="email-content-subject">${email.subject || '(ç„¡ä¸»æ—¨)'}</div>
                        <div class="email-content-meta">
                            ä¾†è‡ªï¼š${sender.name} &lt;${sender.email}&gt;<br>
                            æ—¥æœŸï¼š${new Date(email.date).toLocaleString('zh-TW')}
                        </div>
                    </div>
                    <div>${emailBody}</div>
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="replyEmail()">â†©ï¸ å›è¦†</button>
                        <button class="action-btn" onclick="forwardEmail()">â¡ï¸ è½‰ç™¼</button>
                        <button class="action-btn" onclick="deleteEmail()">ğŸ—‘ï¸ åˆªé™¤</button>
                        ${!email.aiAnalysis || !email.aiAnalysis.aiEnhanced ?
                          '<button class="action-btn" onclick="analyzeEmail()" id="analyzeBtn">ğŸ¤– AI åˆ†æ</button>' : ''}
                    </div>
                </div>

                <div class="ai-section" id="aiAnalysisSection">
                    <h3>ğŸ¤– AI è‡ªå‹•åˆ†æ</h3>
                    <div id="aiAnalysisContent">
                        ${email.aiAnalysis ? renderAIAnalysis(email.aiAnalysis) : '<div class="note-item">é»æ“Šã€ŒAI åˆ†æã€æŒ‰éˆ•é€²è¡Œåˆ†æ</div>'}
                    </div>
                </div>
            `;
        }

        // ===== æ¸²æŸ“ AI åˆ†æçµæœ =====
        function renderAIAnalysis(analysis) {
            let html = '';

            // åŸºç¤åˆ†æ
            html += `<div class="note-item">
                <strong>å„ªå…ˆç´š:</strong> ${analysis.priority || 'N/A'} |
                <strong>æƒ…æ„Ÿ:</strong> ${analysis.sentiment || 'N/A'} |
                <strong>ç·Šæ€¥åº¦:</strong> ${analysis.urgencyLevel || analysis.urgency || 'N/A'}
            </div>`;

            // å•†æ¥­åƒ¹å€¼
            if (analysis.opportunityValue || analysis.estimatedValue) {
                html += `<div class="note-item">
                    <strong>ğŸ’° å•†æ¥­åƒ¹å€¼:</strong> ${analysis.opportunityValue || analysis.estimatedValue}
                </div>`;
            }

            // å®¢æˆ¶æ„åœ–
            if (analysis.customerIntent) {
                html += `<div class="note-item">
                    <strong>ğŸ¯ å®¢æˆ¶æ„åœ–:</strong> ${analysis.customerIntent}
                </div>`;
            }

            // AI å¢å¼·åˆ†æï¼ˆå¦‚æœæœ‰ï¼‰
            if (analysis.aiEnhanced) {
                if (analysis.keyInsights && analysis.keyInsights.length > 0) {
                    html += '<div class="note-item"><strong>ğŸ” æ·±å…¥æ´å¯Ÿ:</strong><ul style="margin: 8px 0 0 20px;">';
                    analysis.keyInsights.forEach(insight => {
                        html += `<li>${insight}</li>`;
                    });
                    html += '</ul></div>';
                }

                if (analysis.nextSteps && analysis.nextSteps.length > 0) {
                    html += '<div class="note-item"><strong>ğŸ“‹ å»ºè­°æ­¥é©Ÿ:</strong><ul style="margin: 8px 0 0 20px;">';
                    analysis.nextSteps.forEach(step => {
                        html += `<li>${step}</li>`;
                    });
                    html += '</ul></div>';
                }

                if (analysis.suggestedResponse) {
                    html += `<div class="note-item">
                        <strong>ğŸ’¬ å»ºè­°å›è¦†:</strong><br>
                        <div style="margin-top: 8px; padding: 8px; background: #f7fafc; border-radius: 4px;">
                            ${analysis.suggestedResponse.replace(/\n/g, '<br>')}
                        </div>
                    </div>`;
                }

                // é¡¯ç¤º API æˆæœ¬
                if (analysis.apiCost) {
                    html += `<div class="ai-cost">ğŸ’µ API æˆæœ¬: $${analysis.apiCost.toFixed(6)}</div>`;
                }
            }

            return html;
        }

        // ===== åˆ†æéƒµä»¶ï¼ˆæ‰‹å‹•è§¸ç™¼ï¼‰ =====
        async function analyzeEmail() {
            if (!selectedEmail) return;

            const btn = document.getElementById('analyzeBtn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'åˆ†æä¸­...';
            }

            try {
                const response = await fetch(`${API_BASE}/ai/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        emailContent: selectedEmail.text || selectedEmail.bodyPreview || '',
                        subject: selectedEmail.subject,
                        from: selectedSender.email
                    })
                });

                const data = await response.json();

                if (data.success) {
                    selectedEmail.aiAnalysis = data.analysis;
                    document.getElementById('aiAnalysisContent').innerHTML = renderAIAnalysis(data.analysis);
                    if (btn) btn.style.display = 'none';
                }
            } catch (error) {
                console.error('âŒ AI åˆ†æå¤±æ•—:', error);
                alert('AI åˆ†æå¤±æ•—: ' + error.message);
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        // ===== é¡¯ç¤ºå¯„ä»¶äºº AI åˆ†æ =====
        function showSenderAI(sender) {
            const contentDiv = document.getElementById('aiDetailContent');

            // çµ±è¨ˆåˆ†æ
            const highPriorityCount = sender.emails.filter(e =>
                e.aiAnalysis && (e.aiAnalysis.priority === 'high' || e.aiAnalysis.urgency === 'urgent')
            ).length;

            contentDiv.innerHTML = `
                <div class="ai-section">
                    <h3>ğŸ‘¤ ${sender.name}</h3>
                    <div style="color: #718096; font-size: 14px; margin-bottom: 12px;">
                        ${sender.email}<br>
                        å…± ${sender.totalEmails} å°éƒµä»¶ | ${sender.unreadEmails} å°æœªè®€
                        ${highPriorityCount > 0 ? ` | <span style="color: #c53030;">${highPriorityCount} å°é«˜å„ªå…ˆ</span>` : ''}
                    </div>
                    <div class="tags">
                        <span class="tag ${sender.priority === 'urgent' ? 'tag-urgent' : sender.priority === 'high' ? 'tag-high' : 'tag-medium'}">
                            ${sender.priority === 'urgent' ? 'ğŸ”´ ç·Šæ€¥' : sender.priority === 'high' ? 'ğŸŸ¡ é«˜å„ªå…ˆ' : 'ğŸŸ¢ ä¸€èˆ¬'}
                        </span>
                        ${sender.value ? `<span class="tag tag-value">${sender.value}</span>` : ''}
                    </div>
                </div>

                <div class="ai-section">
                    <h3>ğŸ“Š éƒµä»¶çµ±è¨ˆ</h3>
                    <div class="note-item">
                        <strong>ç¸½æ•¸:</strong> ${sender.totalEmails} å°<br>
                        <strong>æœªè®€:</strong> ${sender.unreadEmails} å°<br>
                        <strong>é«˜å„ªå…ˆ:</strong> ${highPriorityCount} å°
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; color: #718096; font-size: 14px;">
                    ğŸ‘ˆ é»æ“Šå·¦å´éƒµä»¶æŸ¥çœ‹å…§å®¹å’Œ AI åˆ†æ
                </div>
            `;
        }

        // ===== é—œé–‰éƒµä»¶åˆ—è¡¨ =====
        function closeEmailsList() {
            document.getElementById('emailsListSection').style.display = 'none';
            selectedSender = null;
            selectedEmail = null;
            renderSenders();
            document.getElementById('aiDetailContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ’¡</div>
                    <div>é»æ“Šå¯„ä»¶äººå¡ç‰‡æˆ–éƒµä»¶æŸ¥çœ‹ AI åˆ†æ</div>
                </div>
            `;
        }

        // ===== æ‹–æ‹½åŠŸèƒ½ =====
        function drag(ev) {
            ev.dataTransfer.setData("senderEmail", ev.target.dataset.senderEmail);
            ev.target.classList.add('dragging');
            ev.stopPropagation();
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function dragEnter(ev) {
            if (ev.target.classList.contains('status-zone')) {
                ev.target.classList.add('drag-over');
            }
        }

        function dragLeave(ev) {
            if (ev.target.classList.contains('status-zone')) {
                ev.target.classList.remove('drag-over');
            }
        }

        function drop(ev, newStatus) {
            ev.preventDefault();
            const senderEmail = ev.dataTransfer.getData("senderEmail");
            const sender = sendersMap.get(senderEmail);

            if (sender && sender.status !== newStatus) {
                sender.status = newStatus;
                renderSenders();
                showNotification(`${sender.name} å·²ç§»å‹•åˆ°ã€Œ${getStatusText(newStatus)}ã€`);
            }

            document.querySelectorAll('.status-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
            document.querySelectorAll('.sender-card').forEach(card => {
                card.classList.remove('dragging');
            });
        }

        function getStatusText(status) {
            return status === 'pending' ? 'å¾…è™•ç†' : status === 'processing' ? 'è™•ç†ä¸­' : 'å·²å®Œæˆ';
        }

        // ===== å·¥å…·å‡½æ•¸ =====
        function formatTime(date) {
            const emailDate = new Date(date);
            const now = new Date();
            const diff = now - emailDate;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return emailDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            if (days === 1) return 'æ˜¨å¤©';
            if (days < 7) return `${days} å¤©å‰`;
            return emailDate.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });
        }

        function updateCounts() {
            let pending = 0, processing = 0, completed = 0;

            sendersMap.forEach(sender => {
                if (sender.status === 'pending') pending++;
                else if (sender.status === 'processing') processing++;
                else if (sender.status === 'completed') completed++;
            });

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('processingCount').textContent = processing;
            document.getElementById('completedCount').textContent = completed;
        }

        // ===== éƒµä»¶æ“ä½œ =====
        function composeEmail() {
            document.getElementById('emailTo').value = '';
            document.getElementById('emailSubject').value = '';
            document.getElementById('emailBody').value = '';
            document.getElementById('aiSuggestionContainer').innerHTML = '';
            document.getElementById('composeModal').classList.add('active');
        }

        function closeCompose() {
            document.getElementById('composeModal').classList.remove('active');
        }

        async function sendEmail() {
            const to = document.getElementById('emailTo').value;
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;

            if (!to || !subject) {
                alert('è«‹å¡«å¯«æ”¶ä»¶äººå’Œä¸»æ—¨');
                return;
            }

            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.textContent = 'ç™¼é€ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/email/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: to,
                        subject: subject,
                        text: body
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… éƒµä»¶å·²ç™¼é€ï¼');
                    closeCompose();
                    syncEmails();
                } else {
                    throw new Error(data.error || 'ç™¼é€å¤±æ•—');
                }
            } catch (error) {
                console.error('âŒ ç™¼é€éƒµä»¶å¤±æ•—:', error);
                alert('âŒ ç™¼é€å¤±æ•—: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç™¼é€';
            }
        }

        async function replyEmail() {
            if (!selectedEmail || !selectedSender) return;

            document.getElementById('emailTo').value = selectedSender.email;
            document.getElementById('emailSubject').value = 'Re: ' + (selectedEmail.subject || '');
            document.getElementById('emailBody').value = `\n\n--- åŸå§‹éƒµä»¶ ---\n${selectedEmail.text || selectedEmail.bodyPreview || ''}`;

            // ç²å– AI å›è¦†å»ºè­°
            if (aiEnabled) {
                await generateReplySuggestion();
            }

            document.getElementById('composeModal').classList.add('active');
        }

        async function generateReplySuggestion() {
            const container = document.getElementById('aiSuggestionContainer');
            container.innerHTML = '<div class="ai-suggestion"><div class="loading"></div> AI æ­£åœ¨ç”Ÿæˆå›è¦†å»ºè­°...</div>';

            try {
                const response = await fetch(`${API_BASE}/ai/generate-reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        emailContent: selectedEmail.text || selectedEmail.bodyPreview || '',
                        context: {
                            originalSubject: selectedEmail.subject,
                            from: selectedSender.name
                        }
                    })
                });

                const data = await response.json();

                if (data.success && data.reply.content) {
                    container.innerHTML = `
                        <div class="ai-suggestion">
                            <div class="ai-suggestion-header">ğŸ¤– AI å»ºè­°å›è¦† ${data.reply.apiCost ? `($${data.reply.apiCost.toFixed(6)})` : ''}</div>
                            <div class="ai-suggestion-text">${data.reply.content.replace(/\n/g, '<br>')}</div>
                            <button class="btn btn-secondary" style="margin-top: 8px; font-size: 12px;" onclick="useSuggestion()">
                                ä½¿ç”¨æ­¤å»ºè­°
                            </button>
                        </div>
                    `;
                    // å„²å­˜å»ºè­°ä¾›ä½¿ç”¨
                    window.currentSuggestion = data.reply.content;
                }
            } catch (error) {
                console.error('âŒ ç”Ÿæˆå›è¦†å»ºè­°å¤±æ•—:', error);
                container.innerHTML = '';
            }
        }

        function useSuggestion() {
            if (window.currentSuggestion) {
                document.getElementById('emailBody').value = window.currentSuggestion;
            }
        }

        function forwardEmail() {
            if (!selectedEmail) return;

            document.getElementById('emailTo').value = '';
            document.getElementById('emailSubject').value = 'Fwd: ' + (selectedEmail.subject || '');
            document.getElementById('emailBody').value = `\n\n--- è½‰ç™¼éƒµä»¶ ---\n${selectedEmail.text || selectedEmail.bodyPreview || ''}`;
            document.getElementById('aiSuggestionContainer').innerHTML = '';
            document.getElementById('composeModal').classList.add('active');
        }

        function deleteEmail() {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å°éƒµä»¶å—ï¼Ÿ')) {
                alert('åˆªé™¤åŠŸèƒ½é–‹ç™¼ä¸­...');
            }
        }

        async function syncEmails() {
            await loadEmails();
        }

        function showNotification(message) {
            console.log('ğŸ“¢', message);
        }

        // ===== å•Ÿå‹•æ‡‰ç”¨ =====
        init();

        console.log('ğŸš€ Outlook AI 2.0 çœŸå¯¦ç‰ˆå·²è¼‰å…¥ï¼');
        console.log('âœ¨ ç‰¹è‰²ï¼š');
        console.log('1. è®€å–çœŸå¯¦éƒµä»¶ï¼ˆIMAP/SMTP/Demoï¼‰');
        console.log('2. çœŸå¯¦ OpenAI AI åˆ†æ');
        console.log('3. AI ç”Ÿæˆå›è¦†å»ºè­°');
        console.log('4. è‡ªå‹•æŒ‰å¯„ä»¶äººåˆ†çµ„');
        console.log('5. ä¸‰ç‹€æ…‹æ‹–æ‹½ç®¡ç†');
    </script>
</body>
</html>
